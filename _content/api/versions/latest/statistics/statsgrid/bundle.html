<h1 id="statsgrid2016">statsgrid2016</h1>
<p>Statistics data display. This will replace the statsgrid bundle specification when the implementation has the comparable functionalities as the current one. The bundle depends on mapstats-bundle that provides support for statslayer layertype.</p>
<h2 id="description">Description</h2>
<p>The bundle is used to display and manage statistics data from multiple datasources. It uses maplayers of type statslayer (support provided by mapstats bundle) as regionsets and configuration should provide available datasources. Common dataformat is used to read indicator listings, metadata and actual statistics data from the server. Regions in regionsets are based on the the statslayers and mapping to regions data for statistics data is handled by the server side implementation.</p>
<p>Indicator selector, regionset selector and a datagrid with the indicator data are shown in a flyout. Also manages the statistics data state that is used by mapstats to visualize the data on map.</p>
<h2 id="todo">TODO</h2>
<ul>
<li>add region selection and highlighting in map</li>
<li>add region filtering</li>
<li>add tooltip to map regions with indicator data</li>
</ul>
<h2 id="bundle-configuration">Bundle configuration</h2>
<pre><code class="language-javascript">{
        &quot;sources&quot;: [{
          &quot;id&quot;: 1,
          &quot;name&quot;: &quot;SotkaNET&quot;,
          &quot;type&quot;: &quot;system&quot;
        }, {
          &quot;id&quot;: 2,
          &quot;name&quot;: &quot;KHR&quot;,
          &quot;type&quot;: &quot;system&quot;
        }],
        &quot;grid&quot;: true,
        &quot;allowClassification&quot; : true,
        &quot;vectorViewer&quot;: true
      }
</code></pre>
<ul>
<li><code>sources</code> is required and describes the available datasources. Each datasource have their own indicator listings etc so any reference to indicator must include reference to the datasource the indicator is located in.</li>
<li><code>grid</code> is optional and defaults to true. Toggles if the datatable should be shown</li>
<li><code>allowClassification</code> is optional and defaults to true. Toggles if the user can change the classification for the data.</li>
<li><code>vectorViewer</code> is optional and default to false. Shows region on the map the vector format.</li>
</ul>
<h2 id="bundle-state">Bundle state</h2>
<pre><code class="language-javascript"> {
     &quot;indicators&quot;: [{
         &quot;ds&quot;: 1,
         &quot;id&quot;: 5,
         &quot;selections&quot;: {
             &quot;sex&quot;: &quot;male&quot;,
             &quot;year&quot;: &quot;1991&quot;
         },
         classification : {
          ...
         }
       }
     }, {
         &quot;ds&quot;: 1,
         &quot;id&quot;: 6,
         &quot;selections&quot;: {
             &quot;sex&quot;: &quot;male&quot;,
             &quot;year&quot;: &quot;1994&quot;
         }
     }],
     &quot;regionset&quot;: 7,
     &quot;active&quot;: &quot;1_6_{\&quot;sex\&quot;:\&quot;male\&quot;,\&quot;year\&quot;:\&quot;1994\&quot;}&quot;,
     &quot;view&quot; : true
 }
</code></pre>
<ul>
<li><code>indicators</code> lists any indicators the user has selected with the parameters (selections) that were used when the indicator was selected. DS refers to datasource and id to indicator id in that datasource. Selections vary between datasources and indicators. Classification is the color options and other classification details for the indicator.</li>
<li><code>regionset</code> is the id of the statslayer that is currently used as a regionset</li>
<li><code>active</code> is a &quot;serialized hash&quot; that is used internally to refer to one indicator in the state.indicators list.</li>
<li><code>view</code> is a boolean where true means that the datagrid (flyout) should be shown when the bundle is started. With false the map will render the active indicator but the flyout is closed.</li>
</ul>
<h2 id="requests-the-bundle-sends-out">Requests the bundle sends out</h2>
<table class="table">
  <tr>
    <th>Request</th><th>Why/when</th>
  </tr>
  <tr>
    <td>userinterface.AddExtensionRequest</td><td> Registers as part of the UI </td>
  </tr>
  <tr>
    <td>userinterface.UpdateExtensionRequest</td><td> To open and close the UI programmatically on state change/UIChangeEvent</td>
  </tr>
</table>


<h2 id="events-the-bundle-listens-to">Events the bundle listens to</h2>
<table class="table">
  <tr>
    <th>Event</th><th>How does the bundle react</th>
  </tr>
  <tr>
    <td>userinterface.ExtensionUpdatedEvent</td>
    <td>Enters/exits the statistics mode.</td>
  </tr>
  <tr>
    <td>UIChangeEvent</td>
    <td>Removes the statsgrid UI from the screen when this event is received.</td>
  </tr>
  <tr>
    <td>StatsGrid.IndicatorEvent</td>
    <td>UI grid is updated based on the event.</td>
  </tr>
  <tr>
    <td>StatsGrid.RegionsetChangedEvent</td>
    <td>UI grid is updated based on the event.</td>
  </tr>
  <tr>
    <td>StatsGrid.RegionSelectedEvent</td>
    <td>UI grid is updated based on the event. The corresponding row is highlighted.</td>
  </tr>
  <tr>
    <td>StatsGrid.ActiveIndicatorChangedEvent</td>
    <td>UI grid is updated based on the event. The corresponding column is highlighted.</td>
  </tr>
  <tr>
    <td>StatsGrid.ClassificationChangedEvent</td>
    <td>Updates legend (and map with mapstats) when classification is changed.</td>
  </tr>
</table>

<h2 id="dependencies">Dependencies</h2>
<table class="table">
  <tr>
    <th>Dependency</th><th>Linked from</th><th>Purpose</th>
  </tr>
  <tr>
    <td> Oskari mapmodule</td>
    <td> Expects to be present in the application setup </td>
    <td> To control maplayers as regionsets via requests </td>
  </tr>
  <tr>
    <td> Oskari divmanazer</td>
    <td> Expects to be present in the application setup </td>
    <td> For basic UI components </td>
  </tr>
  <tr>
    <td> [geostats](https://github.com/simogeo/geostats)</td>
    <td> Internally linked from /Oskari/libraries/geostats</td>
    <td> Needed for the classifications of the data</td>
  </tr>
</table>


<h2 id="events-that-the-bundle-sends">Events that the bundle sends</h2>
<table class="table"><tr><th> Event </th><th> Use </th></tr>
<tr><td><a href="events#latest/statistics/statsgrid/event/StatsGrid.ActiveIndicatorChangedEvent.md">StatsGrid.ActiveIndicatorChangedEvent</a></td><td>Notifies when an indicator has been selected (in grid etc).
Components handling indicators should update a "highlighted" indicator where needed.</td></tr><tr><td><a href="events#latest/statistics/statsgrid/event/StatsGrid.ClassificationChangedEvent.md">StatsGrid.ClassificationChangedEvent</a></td><td>Notifies when an classification has been changed (in edit classification).</td></tr><tr><td><a href="events#latest/statistics/statsgrid/event/StatsGrid.DatasourceEvent.md">StatsGrid.DatasourceEvent</a></td><td>Notifies that a datasource has more indicators available (or indicators have been removed).</td></tr><tr><td><a href="events#latest/statistics/statsgrid/event/StatsGrid.IndicatorEvent.md">StatsGrid.IndicatorEvent</a></td><td>Used to notify that an indicator has been added to or removed from selected indicators.</td></tr><tr><td><a href="events#latest/statistics/statsgrid/event/StatsGrid.RegionSelectedEvent.md">StatsGrid.RegionSelectedEvent</a></td><td>Used to notify that a region has been selected in statsgrid.
Components handling regions can update "highlighted" regions or the latest selection.</td></tr><tr><td><a href="events#latest/statistics/statsgrid/event/StatsGrid.RegionsetChangedEvent.md">StatsGrid.RegionsetChangedEvent</a></td><td>Notifies regionset change</td></tr></table>


<hr style="height:50px;">


<h1 id="oskaristatisticsstatsgridcache">Oskari.statistics.statsgrid.Cache</h1>
<p>Used as an internal cache and queue for data retrieval from server.</p>
<h2 id="functions">Functions</h2>
<h3 id="putkey-value">put(key, value)</h3>
<p>Saves the value to a key</p>
<h3 id="getkey">get(key)</h3>
<p>Returns the value for a key</p>
<h3 id="trycachedversioncachekey-callback">tryCachedVersion(cacheKey, callback)</h3>
<p>Tries to find response from cache.
Returns true if cached response was found, callback-function was called and no further processing is needed.
@param  {String}   cacheKey id for the cache
@param  {Function} callback callback to call if there is a cached value
@return {Boolean}  True if cached response was found, callback-function was called and no further processing is needed.</p>
<h3 id="addtoqueuekey-callback">addToQueue(key, callback)</h3>
<p>Adds a callback to a response queue.
When multiple calls are made to same resource we only want to send one request, queue the callbacks and call all of them when we have a response.
@param {String}   key      id for the queue
@param {Function} callback function to add to the queue
@return {Boolean} true if this was not the first queued callback. True means that request is already in progress and we shouldn&#39;t start another, but wait for the response.</p>
<h3 id="respondtoqueuekey-err-response">respondToQueue(key, err, response)</h3>
<p>Finds a queue with the given key and calls the functions that are in the queue with the err and response param values.
Clears the queue after so functions are only called once.
Also caches the response if it&#39;s not an error
@param  {String} key      id for the queue
@param  {String} err      Error message when there is one
@param  {Object} response pretty much anything that needs to be passed to the callbacks as result</p>
<hr style="height:50px;">


<h1 id="oskaristatisticsstatsgridclassificationservice">Oskari.statistics.statsgrid.ClassificationService</h1>
<p>Used to classifify data. Limits as to how the classification can be done are found in an limits-property of the service:</p>
<pre><code class="language-javascript">limits : {
    count : {
        min : 2,
        max : 9,
        def : 5
    },
    method : [&#39;jenks&#39;, &#39;quantile&#39;, &#39;equal&#39;],
    mode : [&#39;distinct&#39;, &#39;discontinuous&#39;]
}
</code></pre>
<h2 id="functions-1">Functions</h2>
<h3 id="getclassificationindicatordata-options">getClassification(indicatorData, options)</h3>
<p>Classifies given dataset. Expects data as object like:
 {
    key1 : 1,
    key2 : 3,
    key3 : 2
 }</p>
<p>Options can include:
  {
     count : &lt;number between 2-9 - defaults to 5&gt;,
     method : &lt;one of &#39;jenks&#39;, &#39;quantile&#39;, &#39;equal&#39; - defaults to &#39;jenks&#39;&gt;,
     mode : &lt;one of &#39;distinct&#39;, &#39;discontinuous&#39; - defaults to &#39;distinct&#39;&gt;,
     precission : &lt;undefined or integer between 0-20 - defaults to undefined&gt;
  }</p>
<p>Returns an object like:
 {
      bounds : [&lt;classification bounds as numbers like [0,2,5,6]&gt;],
      ranges : [&lt;classification ranges as strings [&quot;0-2&quot;, &quot;2-5&quot;, &quot;5-6&quot;]&gt;],
      stats : {
          min : <min value in data>,
          max : <max value in data>,
          ...
          mean : <mean value in data>
      },
      getGroups : &lt;function to return keys in data grouped by value ranges, takes an optional param index to get just one group&gt;,
      getIndex : &lt;function to return a group index for data - TODO: is this needed since we have getGroups?&gt;,
      createLegend : &lt;function to create html-legend for ranges, takes colorset and optional title as params&gt;
  }</p>
<pre><code class="language-javascript">var data = {
    key1 : 1,
    key2 : 3,
    key3 : 2
 };
var result = service.getClassification(data, {count : 2});

var groups = result.getGroups(); // returns [[key1, key3], [key2]]
var firstGroup = result.getGroups(0) // returns [key1, key3]
var theseMatch = groups[0] === firstGroup; // true

// using the index, we can get group of keys in the same classification group
var groupIndexForKey2 = result.getIndex(data[key2]) // returns 1
var groupWithKey2 = result.getGroups(groupIndexForKey2) -&gt; returns [key2]
var theseMatchAlso = groups[groupIndexForKey2] === groupWithKey2; // true
</code></pre>
<hr style="height:50px;">


<h1 id="oskaristatisticsstatsgridcolorservice">Oskari.statistics.statsgrid.ColorService</h1>
<p>Used to get colorset for classified data. Available options for colorsets are found in an limits-property of the service:</p>
<pre><code class="language-javascript">limits : {
    type : [&#39;div&#39;, &#39;seq&#39;, &#39;qual&#39;],
    defaultType : &#39;div&#39;,
    name : [...list of colorset names...],
    defaultName : &#39;BrBG&#39;,
    count : {
        min : 2,
        max : 9
    }
}
</code></pre>
<h2 id="functions-2">Functions</h2>
<h3 id="getcolorsetcount-type-name">getColorset(count, type, name)</h3>
<p>Tries to return an array of colors where length equals count parameter. If such set is not available, returns null if array with requested count is not available. If type or name is given, tries to find closest match, but fallsback to returning the best matching colorset if specific is not found.
@param  {Number} count number of colors requested
@param  {String} type  optional type, supports &#39;div&#39;, &#39;seq&#39; or &#39;qual&#39;, defaults to &#39;div&#39;
@param  {String} name  optional name, defaults to &#39;BrBG&#39;
@return {String[]}     array of hex-strings as colors like [&quot;d8b365&quot;,&quot;5ab4ac&quot;]</p>
<hr style="height:50px;">


<h1 id="oskaristatisticsstatsgridstateservice">Oskari.statistics.statsgrid.StateService</h1>
<p>Used to set and store the state of the statsgrid functionality. Sends out events when the state is changed: indicator added/removed, regionset changed, region selected or active indicator changed.</p>
<hr style="height:50px;">


<h1 id="oskaristatisticsstatsgridstatisticsservice">Oskari.statistics.statsgrid.StatisticsService</h1>
<p>Used to fetch statistics data from the server.</p>
